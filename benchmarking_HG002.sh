'''
Author: Shloka Negi, shnegi@ucsc.edu
Usage: Execute line by line, or blocks of code as required
Purpose: Benchmarking mC mods from HG002 generated by SINGLE v/s DUAL mode, against HG002 "Truth" set
Input file requirements: HG002 merged_withMODs_mapped_BAM file generated by Monika Cechova, mcechova@ucsc.edu
Conda environments: /public/home/shnegi/.conda/envs/DNAmod
                  : /public/home/shnegi/.conda/envs/DNAmod/envs/modbam2bed

Benchmarking data downloaded from: 
    Bisulfite Seq: wget https://ont-open-data.s3.amazonaws.com/gm24385_mod_2021.09/bisulphite/cpg/CpG.gz.bismark.zero.cov.gz
    Nanopore Seq: https://ont-open-data.s3.amazonaws.com/gm24385_mod_2021.09/extra_analysis/all.cpg.bed
'''

source /opt/miniconda/etc/profile.d/conda.sh
conda activate /public/home/shnegi/.conda/envs/DNAmod/envs/modbam2bed

## Convert aligned merged BAM file (with mods) into BED file
modbam2bed \
    -e -m 5mC --cpg -t 10 -a 0.333 -b 0.667 \
    ./chrX_hg38.fa \
    ./chrX.HG002_on_GRCh38_no_alt.merged.bam > HG002_dual.bed

modbam2bed \
    -e -m 5mC --cpg -t 10 \
    ./chrX_hg38.fa \
    ./chrX.HG002_on_GRCh38_no_alt.merged.CpG.bam > HG002_single.bed


## Setting filtering threshold to 90% - HG002
cat HG002_single.bed | awk '{ if ($11 >= 90) print $0 }' > HG002_single_highconf.bed
cat HG002_dual.bed | awk '{ if ($11 >= 90) print $0 }' > HG002_dual_highconf.bed


## Preparing Benchmark Data
conda activate /public/home/shnegi/.conda/envs/DNAmod
#1. Bisulfite Seq Data
wget https://ont-open-data.s3.amazonaws.com/gm24385_mod_2021.09/bisulphite/cpg/CpG.gz.bismark.zero.cov.gz
cat CpG.gz.bismark.zero.cov | awk 'NR > 62 {print $1 "\t" $2 "\t" $3}' > all.cpg_BS.bed
bedextract chrX all.cpg_BS.bed > chrX.cpg_BS.bed

#2. Nanopore Seq Data
wget https://ont-open-data.s3.amazonaws.com/gm24385_mod_2021.09/extra_analysis/all.cpg.bed
mv all.cpg.bed all.cpg_NP.bed
bedextract chrX all.cpg_NP.bed > chrX.cpg_NP.bed


## Benchmarking
#1. Intersecting high confidence SINGLE and DUAL mC mods with Bisulfite Data
bedtools intersect -a chrX.cpg_BS.bed -b HG002_single_highconf.bed | wc -l
bedtools intersect -a chrX.cpg_BS.bed -b HG002_dual_highconf.bed | wc -l

#2. Intersecting high confidence SINGLE and DUAL mC mods with Nanopore Data
bedtools intersect -a chrX.cpg_NP.bed -b HG002_single_highconf.bed | wc -l
bedtools intersect -a chrX.cpg_NP.bed -b HG002_dual_highconf.bed | wc -l
